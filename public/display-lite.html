<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>TRAPO Display Lite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html, body {
        margin: 0; padding: 0;
        width: 100vw; height: 100vh;
        overflow: hidden;
        background: #000;
        color: #fff;
        font-family: 'Poppins', sans-serif;
      }

      .container {
        position: relative;
        width: 100vw; height: 100vh;
        background-image: url('/assets/bgcard.png');
        background-size: cover;
        background-position: center;
        display: flex; justify-content: center; align-items: center;
        animation: fadein 0.8s ease-out forwards;
      }

      .overlay {
        position: absolute; inset: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent 40%, rgba(0,0,0,0.8));
      }

      .content {
        z-index: 10;
        text-align: center;
        width: 90vw; max-width: 100vw;
        height: 100%;
        padding: 6vh 4vw;
        display: flex; flex-direction: column;
        justify-content: space-between; align-items: center;
      }

      .logo-center {
        width: 40vw; max-width: 420px;
        opacity: 0.95;
        filter: drop-shadow(0 0 50px rgba(56,71,209,0.8));
        animation: pulse-slow 6s ease-in-out infinite;
      }

      /* Posisi logo idle lebih turun */
      .logo-idle {
        position: relative;
        top: 30vh;
      }

      .label {
        font-size: clamp(14px,2vw,22px);
        color: #f3f4f6;
        letter-spacing: 0.15em;
        text-shadow: 0 0 10px rgba(56,71,209,0.8),
                     0 0 14px rgba(255,255,255,0.5),
                     0 0 18px rgba(56,71,209,0.6);
      }

      .customer {
        margin-top: 5vh;
        margin-bottom: 7vh;
        font-size: clamp(20px,3vw,32px);
        font-weight: 600;
        text-transform: uppercase;
        text-shadow: 0 0 8px rgba(0,0,0,0.7);
      }

      .cartype {
        margin-top: 1vh;
        font-weight: 800;
        text-shadow: 0 0 12px rgba(56,71,209,0.8),
                     0 0 25px rgba(214,51,132,0.6),
                     0 0 40px rgba(0,0,0,0.9);
        letter-spacing: 0.05em;
      }

      /* âœ… Tetap horizontal dan center */
      .grid {
        display: flex;
        justify-content: center;
        align-items: stretch;
        width: 100%;
        margin-top: 5vh;
      }

      /* Fallback manual untuk TV yang tidak support flex gap */
      .grid .card:first-child {
        margin-right: 5vw;
      }

      .card {
        flex: 0 1 35%;
        min-width: 420px;
        background: rgba(0,0,0,0.45);
        border: 1px solid rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
        box-shadow: inset 0 0 15px rgba(255,255,255,0.1);
        padding: 1vh 2vw;
        border-radius: 10px;
      }

      .card-value {
        margin-top: 1vh;
        font-weight: 700;
        text-shadow: 0 0 10px rgba(0,0,0,0.8);
      }

      .finish {
        margin-top: 1vh;
        font-weight: 800;
        text-shadow: 0 0 20px rgba(56,71,209,0.8),
                     0 0 30px rgba(214,51,132,0.5);
      }

      .logo-watermark {
        position: absolute;
        bottom: 3vh; right: 4vw;
        width: clamp(60px,10vh,220px);
        opacity: 0.9;
        filter: drop-shadow(0 0 40px rgba(56,71,209,0.7));
      }

      @keyframes pulse-slow {
        0%,100% { transform: scale(1); opacity: 0.9; filter: drop-shadow(0 0 40px rgba(56,71,209,0.4)); }
        50% { transform: scale(1.08); opacity: 1; filter: drop-shadow(0 0 80px rgba(56,71,209,0.8)); }
      }

      @keyframes fadein {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
      }

      @media (max-width: 1024px) {
        .grid {
          flex-direction: column;
          align-items: center;
          gap: 3vh;
        }
        .grid .card:first-child {
          margin-right: 0;
          margin-bottom: 3vh;
        }
      }
    </style>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  </head>

  <body>
    <div class="container">
      <div class="overlay"></div>
      <div class="content">
        <div id="mainContent">
          <img src="/assets/LOGO_TRAPO.png" class="logo-center logo-idle" alt="TRAPO Logo" />
        </div>
      </div>
      <img src="/assets/LOGO_TRAPO.png" class="logo-watermark" alt="TRAPO Logo" />
    </div>

    <script>
			// ðŸŒ PARAMETER
			const params = new URLSearchParams(window.location.search);
			const id = params.get("id");
			const backend = "http://trapo-id.cloud";
			const main = document.getElementById("mainContent");

			// ðŸ§­ AUTO FULLSCREEN (dengan retry untuk TV lawas)
			function goFullscreen() {
				const elem = document.documentElement;
				if (elem.requestFullscreen) elem.requestFullscreen().catch(() => {});
				else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
				else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
			}
			document.addEventListener("DOMContentLoaded", goFullscreen);
			setInterval(() => {
				if (!document.fullscreenElement && !document.webkitFullscreenElement) goFullscreen();
			}, 3000);

			// ðŸ“… Format tanggal
			const formatDate = (dateStr) => {
				if (!dateStr) return "-";
				try {
					const date = new Date(dateStr);
					return date.toLocaleDateString("id-ID", { day: "numeric", month: "long", year: "numeric" });
				} catch {
					return dateStr;
				}
			};

			// ðŸ”  Font adaptif
			const dynamicFontSize = (text, base = 4.2, max = 60) => {
				if (!text) return `clamp(24px, ${base}vw, ${max}px)`;
				const len = text.length;
				if (len > 30) return `clamp(20px, ${base - 1.4}vw, ${max - 14}px)`;
				if (len > 20) return `clamp(22px, ${base - 0.9}vw, ${max - 10}px)`;
				if (len > 15) return `clamp(24px, ${base - 0.5}vw, ${max - 6}px)`;
				return `clamp(24px, ${base}vw, ${max}px)`;
			};

			// ðŸ§¹ Normalisasi payload dari backend
			function sanitize(data) {
				if (!data) return null;

				// Tipe boolean/string/number ke boolean
				const inactive =
					data.is_active === false ||
					data.is_active === 0 ||
					data.is_active === "0" ||
					data.is_active === "false";

				// Kalau backend kirim flag removed/cleared
				const removed = data.removed === true || data.cleared === true || data.action === "removed";

				// Kalau tidak ada nama customer, anggap kosong
				const noCustomer = !data.customer_name || String(data.customer_name).trim() === "";

				if (inactive || removed || noCustomer) return null;

				return data;
			}

			// ðŸŽ¨ Render UI
			function render(d) {
				if (!d) {
					// Idle state (logo turun)
					main.innerHTML = `<img src="/assets/LOGO_TRAPO.png" class="logo-center logo-idle" alt="TRAPO Logo" />`;
					return;
				}

				const carText = `${d.brand || ""} ${d.type || ""} ${d.year ? "â€¢ " + d.year : ""}`.trim();

				main.innerHTML = `
					<div>
						<p class="customer">${d.customer_name ?? ""}</p>
						<p class="label">CAR TYPE</p>
						<h2 class="cartype" style="font-size:${dynamicFontSize(carText, 5, 64)}">${carText}</h2>

						<div class="grid">
							<div class="card">
								<p class="label">SERVICE TYPE</p>
								<p class="card-value" style="font-size:${dynamicFontSize(d.service, 3.5, 42)}">${d.service || "-"}</p>
							</div>
							<div class="card">
								<p class="label">PLATE NUMBER</p>
								<p class="card-value" style="font-size:${dynamicFontSize(d.license_plate, 3.5, 42)}">${d.license_plate || "-"}</p>
							</div>
						</div>

						<div style="margin-top:10vh">
							<p class="label">FINISH DATE</p>
							<p class="finish" style="font-size:${dynamicFontSize(formatDate(d.estimated_time), 4, 46)}">${formatDate(d.estimated_time)}</p>
						</div>
					</div>
				`;
			}

			// ðŸ§© Fetch awal (no-cache) + sanitasi
			fetch(`${backend}/api/screens/${id}`, { cache: "no-store" })
				.then((r) => (r.ok ? r.json() : null))
				.then((data) => render(sanitize(data)))
				.catch(() => (main.innerHTML = `<p style="font-size:2vw">Gagal memuat data</p>`));

			// ðŸ”Œ Socket realtime (pakai websocket langsung & auto-reconnect)
			const socket = io(backend, {
				transports: ["websocket"],
				reconnection: true,
				reconnectionAttempts: 10,
				timeout: 20000,
			});

			socket.on("connect", () => {
				console.log("ðŸŸ¢ socket connected", socket.id);
				socket.emit("join_screen", id);
			});

			// Event utama dari backend
			socket.on("screen:update", ({ screen_id, payload }) => {
				if (String(screen_id) !== String(id)) return;
				const cleaned = sanitize(payload);
				console.log("ðŸ“¡ update:", { screen_id, cleaned, raw: payload });
				render(cleaned);
			});

			// Antisipasi event lain dari backend jika dipakai
			socket.on("screen:clear", ({ screen_id }) => {
				if (String(screen_id) !== String(id)) return;
				render(null);
			});
			socket.on("screen:removed", ({ screen_id }) => {
				if (String(screen_id) !== String(id)) return;
				render(null);
			});

			// Optional: kalau server kirim sinyal status aktif/nonaktif terpisah
			socket.on("screen:status", ({ screen_id, is_active }) => {
				if (String(screen_id) !== String(id)) return;
				if (!is_active) render(null);
			});

			// Debug error
			socket.on("connect_error", (e) => console.warn("socket connect_error:", e?.message || e));
			socket.on("error", (e) => console.warn("socket error:", e));
		</script>
  </body>
</html>
